<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Inference via Conditional Permutation Tests | Daniel C. Posmik</title> <meta name="author" content="Daniel C. Posmik"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://posmikdc.github.io/projects/cond_permutation/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Daniel </span>C. Posmik</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">More</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/repositories/">Repositories</a> <a class="dropdown-item" href="/teaching/">Teaching</a> <a class="dropdown-item" href="/Users/posmikdc/Documents/assets/cv/cv.pdf">CV</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Inference via Conditional Permutation Tests</h1> <p class="post-description"></p> </header> <article> <h2 id="introduction">Introduction</h2> <p>In hypothesis testing, knowledge about the null distribution is critical. If the null distribution is misspecified, inference may be biased and invalid. In multiple testing scenarios, this vulnerability to misspecification persists. That is why we explore a non-parametric permutation-based approach to multiple testing using conditional permutation tests. The conditional permutation tests–as opposed to a canonical permutation strategy–incorporate covariates into the inferential procedure.</p> <h2 id="data-and-working-example">Data and Working Example</h2> <p>As members of the UChicago community, we are aware of occasional safety risks present. The University of Chicago’s administration has responded to these concerns in multiple ways. One of them is offering students up to 10 free Lyft rides per quarter. This has made us curious whether there is a significant association between neighborhood of origin and late night taxi rides. We hypothesize that certain communities in Chicago, especially Hyde Park, are more strongly associated with late night taxi ridership. In our analysis, we account for data from 2014 and 2019. In the following analysis, we will be testing whether there is a relationship between late night rides and over 60 pickup locations, i.e. neighborhoods in Chicago. This results in a multiple testing problem. We generate p-values via (1) a proportion test and (2) via a conditional permutation test, attempting to correct for multiple testing in the latter.</p> <pre><code class="language-{r}"># General wrangling
taxi_df &lt;- taxi_dta %&gt;%
  # Data wrangling
  mutate(year = substr(trip_start_timestamp, 1, 4),
         month = substr(trip_start_timestamp, 6, 7),
         temp = ifelse(month &gt;= '04' &amp; month &lt;= '09', 0, 1),
         pickup_hour = substr(trip_start_timestamp, 12, 13),
         late_ride = ifelse((pickup_hour &gt;= '00' &amp; pickup_hour &lt;= '04') | 
                              (pickup_hour &gt;= '22' &amp; pickup_hour &lt;= '23'), 
                            1, 0)) %&gt;%
  # Filter to 2019
  filter(year == '2014' | year == "2019") %&gt;%
  # Retain only relevant data
  select(pickup_community_area, year, temp, late_ride)

#Filter out pickup locations with less than 1000 data points
  counts = as.data.frame(table((taxi_df[, "pickup_community_area"])))
  counts = counts[!(counts$Freq&lt;1000),]
  taxi_df = taxi_df[(taxi_df$pickup_community_area %in% counts[,1]),]

# Summary Statistics
print(paste0("There are ",length(unique(taxi_df$pickup_community_area))," distinct pickup locations. ",sum(taxi_df$late_ride)*100/nrow(taxi_df),"% of rides are classified as late-night rides."))
</code></pre> <p>Exploratory analysis revealed that multiple communities only have very few ridership data. Thus, we decided to focus only on communities that have more than 1,000 rides. Though it is somewhat arbitrary, we defined a late ride pickup as a taxi ride occuring between 10pm and 4am. Moreover, we controlled for a temperature variable since we are familiar with the harsh Chicago winters. Since no accurate temperature variable is given within the data, we decided to assign a binary cold vs. warm variable to cold and warm months, respectively. We classified September through April as cold months.</p> <h2 id="proportion-test">Proportion Test</h2> <p>We plan on obtaining p-values in two different ways. First, we obtain p-values by performing a proportion test between 2014 and 2019 late night ride proportions.</p> <pre><code class="language-{r}"># 2014 observations only
prop14_df &lt;- taxi_df %&gt;%
  filter(year == '2014') %&gt;%
  select(pickup_community_area, late_ride) %&gt;%
  group_by(pickup_community_area) %&gt;%
  summarise(late_ride = sum(late_ride), 
            all_ride = n())

# 2019 observations only
prop19_df &lt;- taxi_df %&gt;%
  filter(year == '2019') %&gt;%
  select(pickup_community_area, late_ride) %&gt;%
  group_by(pickup_community_area) %&gt;%
  summarise(late_ride = sum(late_ride), 
            all_ride = n())

# Column bind
prop_df &lt;- merge(prop14_df, prop19_df, 
                 by = "pickup_community_area",
                 suffixes = c("_14", "_19"))
</code></pre> <p>Now, we can perform the proportion test and obtain a vector of p-values.</p> <pre><code class="language-{r}"># Significance Cutoff
alpha = 0.05

# Function to calculate p-values
pvals_prop &lt;- function(df) {
  # Initialize an empty vectors to store p-values
  res &lt;- numeric(nrow(df))
  pvals &lt;- numeric(nrow(df))
  for (i in 1:nrow(df)) {
    # Rowwise proportion test
    res &lt;- prop.test(x = c(df[i,2], df[i,4]), n = c(df[i,3], df[i,5]))
    # Store the p-value in the res vector
    pvals[i] &lt;- res$p.value
  }
  # Return
  return(pvals)
}

# P-values
pvals_prop &lt;- as.data.frame(cbind(prop_df[,1], pvals_prop(prop_df)))

# Histogram
hist(pvals_prop[,2])

# Performance: No correction
print(paste0("When comparing proportions and without any multiple testing correction, ",sum(pvals_prop[,2] &lt; alpha)," out of ",nrow(pvals_prop), " cases have a p-value under the significance cutoff of ", alpha))
</code></pre> <p>The results are indicative of the multiple testing issues present in the data. Our null hypothesis is that there is no relationship between pickup origin and late night ridership. We are testing this null hypothesis against 18 alternative hypothesis. With each statistical test, the probability of obtaining false positives increases. Therefore, we decided to obtain a second set of p-values using a conditional permutation test.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/cond_perm_map_prop-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/cond_perm_map_prop-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/cond_perm_map_prop-1400.webp"></source> <img src="/assets/img/cond_perm_map_prop.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> This figure visualizes the association between late night ridership and pickup origin (with the proportion test p-values) </div> <h2 id="permutation-test">Permutation Test</h2> <p>We now apply a conditional permutation test (CPR) as outlined in <a href="https://arxiv.org/pdf/1807.05405.pdf" rel="external nofollow noopener" target="_blank">Berrett et al., 2018</a>. For us, applying a conditional permutation test is especially useful because we can now test conditional independence, i.e. \(X\) independent from \(Y \vert Z\), rather than just \(X\) independent from \(Y\) as in the previous proportion test. This allows us to account for relevant influence from confounders. Additionally, the conditional permutation test allows us to construct a sampling distribution, rather than assuming it, by resampling combinations of X for each permutation \(X^{(m)}\).</p> \[p = \frac{1 + \sum_{m = 1}^{M} \mathbb{1}\{T(\mathbf{X}^{(m)}, \mathbf{Y}, \mathbf{Z}) \geq T(\mathbf{X}, \mathbf{Y}, \mathbf{Z})\}}{1 + M}\] <p>As our test statistic, we have chosen a logistic regression model, regressing late_ride (\(Y\)) on pickup community (\(X\)). Moreover, we control by year and temperature (\(Z\)). We chose a logistic regression model because the dependent variable is binary. Our test statistics, being a function of our data, will output coefficients. We call the non-permuted coefficient vector \(b_T\) and the permuted coefficient vectors \(b_{p_1}, b_{p_2}, ..., b_{p_m}\).</p> <p>It is noteworthy that computational feasibility prevents us from implementing n!, i.e. 18! = 6.4023737e+15, permutations. Thus, we chose to implement an approximate permutation test with a fixed M large enough to account for a reasonable set of permutations without exceeding a reasonable computational time frame.</p> <pre><code class="language-{r}"># Number of permutations
M = 250

# Isolate X_T 
perm_X &lt;- as.data.frame(taxi_df[,1]) %&gt;%
  rename(X_T = `taxi_df[, 1]`)

# Create a function to permute the data
permute_data &lt;- function(data) {
  return(sample(data, replace = FALSE))
}

# Loop to create M new columns with permuted data
for (i in 1:M) {
  new_col &lt;- permute_data(perm_X$X_T)
  col_name &lt;- paste0("Xp_", i)
  perm_X[col_name] &lt;- new_col
}

# Merge the non-permuted df back
perm_df &lt;- cbind(perm_X, taxi_df[,2:4])
</code></pre> <p>We have obtained a permuted data frame. Let us now turn to the test statistic: A logistic regression model. Note that the logistic regression model only iterates through the <code class="language-plaintext highlighter-rouge">M + 1</code> column vectors of permuted pickup origin. Interestingly, <a href="https://arxiv.org/pdf/1807.05405.pdf" rel="external nofollow noopener" target="_blank">Berrett et al., 2018</a> propose a slightly different fix if Z is categorical. Namely, “there is a simple and well- known fix for this problem: we can group the observations according to their value of Z, and then permute within groups.” We decided against this approach because our logistic regression model accounts for the conditional dependence. Thus, permuting within each group of \(Z\), i.e. within cold and warm months, would be redundant.</p> <pre><code class="language-{r}"># Create an empty matrix to store the coefficients
coeff_matrix &lt;- 
  matrix(NA, nrow = nrow(pvals_prop) - 1 + 3, # -1 comparison dummy; +3 [intercept term + 2 covariates]
         ncol = M + 1)

# Run a logistic regression model `M + 1` times and store coefficients
for (m in 1:(M+1)) {
  lreg &lt;- glm(late_ride ~ factor(perm_df[,m]) + factor(year) + temp, 
              data = perm_df, 
              family = binomial)
  # Store the coefficients in the matrix
  coeff_matrix[, m] &lt;- as.vector(coef(lreg))
}

# Store coeff_matrix and keep only neighborhoods
coeff_df &lt;- as.data.frame(coeff_matrix) %&gt;%
  slice(-1, -c(n()-2,n())) # keep only neighborhood betas

# Absolute value to coeff_df
coeff_df &lt;- abs(coeff_df)
</code></pre> <p>We know have a matrix that includes coefficients for all neighborhoods across the original data and the permutations. Finally, let us calculate the p-values using Equation (3) from <a href="https://arxiv.org/pdf/1807.05405.pdf" rel="external nofollow noopener" target="_blank">Berrett et al., 2018</a>.</p> <pre><code class="language-{r}"># Significance Cutoff
alpha = 0.05

# Function to calculate p-values
cpt &lt;- function(df) {
  # Numeric shell
  pvals &lt;- numeric(nrow(df))
  # Conditional permutation test
  for (i in 1:nrow(df)){
    pvals[i] &lt;- (1 + (sum(df[i,] &gt;= df[i,1]))) / (1 + ncol(df))
  }
  # Return
  return(pvals)
}

# Calculate p-values
pvals_perm &lt;- cpt(coeff_df)

# Histogram
hist(pvals_perm)

# Performance: Permutation
print(paste0("When applying a permutation test, ", sum(pvals_perm &lt; alpha)," out of ",length(pvals_perm), " cases have a p-value under the significance cutoff of ", alpha))
</code></pre> <p>We can see that the p-values are bunched up at 0 after we have permuted. However, it does seem that the p-values are slightly less extremely bunched up at 0. This is good news because our results remain significant even when we construct a new sampling proportion via permutation.</p> <h2 id="visualization">Visualization</h2> <p>Finally, let us visualize our results. We will visualize the neighborhood-specific p-values from the two tests we performed.</p> <pre><code class="language-{r}"># Read in map
map &lt;- st_read("~/Downloads/boundaries/geo_export_e28691ab-0ce8-47d4-a608-9cf7265ff34a.shp")

# Merge in proportion p-values
map &lt;- merge(map, pvals_prop, 
             by.x = "area_numbe", by.y = "V1", 
             all = TRUE)

# Merge permuted pvals back with neighborhood index
pvals_perm_idx &lt;- c(2,3,4,5,6,7,8,16,22,24,28,32,33,41,56,76,77)
pvals_perm_df &lt;- cbind(pvals_perm_idx, pvals_perm)

# Merge in in permuted p-values
map &lt;- merge(map, pvals_perm_df, 
             by.x = "area_numbe", by.y = "pvals_perm_idx", 
             all = TRUE)
</code></pre> <p>Now, we can contrast our p-values on a neighborhood map. Please note that this visualization does not represent coefficients, but p-values. Thus, these maps should be interpreted as confidence in an association between late night ridership and pickup location.</p> <pre><code class="language-{r}"># Visualization of Proportion P-Values
ggplot() +
  geom_sf(data = map, aes(fill = V2)) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(title = "Late Night Rides and Neighborhood: Proportion P-Values") +
  theme_minimal()

# Visualization of Permuted P-Values
ggplot() +
  geom_sf(data = map, aes(fill = pvals_perm)) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(title = "Late Night Rides and Neighborhood: Permuted P-Values") +
  theme_minimal()
</code></pre> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/cond_perm_map_perm-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/cond_perm_map_perm-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/cond_perm_map_perm-1400.webp"></source> <img src="/assets/img/cond_perm_map_perm.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> This figure visualizes the association between late night ridership and pickup origin (with the permutation-based p-values) </div> <p>Overall, both maps tell a story that is not very surprising. As we had hypothesized, Hyde Park is only one of two significant neighborhoods in the South side. The other one is Garfield Ridge, the location of Midway airport. Hyde Park’s significance likely has a lot to do with students taking taxis out of Hyde Park late at night. Furthermore, O’Hare airport is strongly significant. This makes sense since we expect a major international airport to have a lot of late night taxi ridership. Lastly, it is interesting to see that the North Side is very significant, e.g., Lincoln Park and Lakeview. We believe this could be associated with the night life and the comparatively wealthy residents.</p> <p>Although the differences between the two sets of p-values are small, they are noticeable in the North Side. Some neighborhoods around Lakeview–especially Edgewater and Lincoln Park–become less significant after we conduct the permutation test. This is indicative of the multiple testing correction we performed via permutation.</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Daniel C. Posmik. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>